
matrix:
  include:
    - language: java
      dist: trusty
      jdk: oraclejdk8
      # disable shallow clone so that sonar-scanner has full blame information
      git:
        depth: false
      addons:
        sonarcloud:
          organization: "kuul-development"
      services:
        - docker
      install:
        - npm install typescript
      before_script:
        - cd server
      script:
        - mvn clean install -Pcoverage
        - docker build .
        # the sonar analysis is triggered for the whole project (including frontend)
        - cd ..
        - sonar-scanner
      deploy:
        provider: elasticbeanstalk
        access_key_id: ${AWS_ACCESS_KEY_ID}
        secret_access_key: ${AWS_SECRET_ACCESS_KEY}
        env: "kuul-server-env"
        app: "kuul-server-app"
        bucket: "kuul-server"
        edge: true # opt in to dpl v2
        on:
          branch: cloud-deployment

    - language: node_js
      dist: xenial
      before_script:
        - cd ui
        - nvm install 13
        - nvm use node
        - npm install
      script:
        - ng build --prod
      deploy:
        provider: s3
        access_key_id: ${AWS_ACCESS_KEY_ID}
        secret_access_key: ${AWS_SECRET_ACCESS_KEY}
        bucket: "testbucket-pekr"
        skip_cleanup: true
        local_dir: dist/ui
        on:
          branch: cloud-deployment

